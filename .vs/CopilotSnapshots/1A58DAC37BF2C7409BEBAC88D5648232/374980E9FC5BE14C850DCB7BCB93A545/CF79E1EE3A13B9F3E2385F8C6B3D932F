using UnityEngine;
using UnityEngine.UI;
using TMPro;
using Unity.Services.Core;
using Unity.Services.Authentication;
using UnityEngine.SceneManagement;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Runtime.CompilerServices;

public class AuthManager : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private Button signUpButton;          // "Sign In" / first button
    [SerializeField] private Button nextButton;            // "Continue" button
    [SerializeField] private TextMeshProUGUI usernameDisplay;
    [SerializeField] private TextMeshProUGUI playerIdDisplay; // Optional; leave unassigned to hide

    private bool busy;

    // removed PlayerNameKey / PlayerIdKey constants; use PlayerProfile instead

    public static string LocalPlayerName => PlayerProfile.Username; // FULL Name#1234
    public static string LocalPlayerId => PlayerProfile.PlayerId;
    private void Start()
    {
        if (nextButton) nextButton.gameObject.SetActive(false);
        if (usernameDisplay) usernameDisplay.text = "Generate your username";
        if (signUpButton) signUpButton.onClick.AddListener(OnSignUpClicked);
        if (nextButton) nextButton.onClick.AddListener(OnNextClicked);
        _ = SafeInitAsync(); // still runs asynchronously; Start itself isn’t async
        if (playerIdDisplay) playerIdDisplay.gameObject.SetActive(false);
    }

    private async Task SafeInitAsync()
    {
        if (UnityServices.State == ServicesInitializationState.Initialized) return;
        try { await UnityServices.InitializeAsync(); }
        catch { /* ignore; handled on click path */ }
    }

    private async void OnSignUpClicked()
    {
        if (busy) return;
        busy = true;

        if (signUpButton) signUpButton.interactable = false;
        if (usernameDisplay) usernameDisplay.text = "Generating your identity...";

        try
        {
            await EnsureSignedInAsync();

            // 1) Base name without discriminator
            var baseName = Sanitize(GetOrGenerateUsername());

            // 2) Ask UGS to use that; it may append "#1234"
            await AuthenticationService.Instance.UpdatePlayerNameAsync(baseName);

            // 3) Grab the FINAL value as seen by UGS
            var actualName = AuthenticationService.Instance.PlayerName ?? baseName;

            // 4) Save internally as FULL "Name#1234"
            PlayerProfile.Username = actualName;
            PlayerProfile.PlayerId = AuthenticationService.Instance.PlayerId;
            PlayerProfile.Save();

            // 5) For UI, trim the "#1234" part so kids see a clean name
            string displayName = TrimDiscriminator(actualName);

            ProfileHUD.Instance?.SetName(displayName);

            // UI updates
            if (usernameDisplay) usernameDisplay.text = $"Hi, {displayName}";

            if (playerIdDisplay)
            {
                playerIdDisplay.text = AuthenticationService.Instance.PlayerId;
                playerIdDisplay.gameObject.SetActive(false); // keep hidden for kids; flip to true if you want it visible
            }

            if (signUpButton) signUpButton.gameObject.SetActive(false);
            if (nextButton) nextButton.gameObject.SetActive(true);
        }
        catch
        {
            if (usernameDisplay) usernameDisplay.text = "Network hiccup. Try again.";
            if (signUpButton) signUpButton.interactable = true;
        }
        finally
        {
            busy = false;
        }
    }

    private void OnNextClicked()
    {
        // Change this to your next scene name
        SceneManager.LoadScene("MainMenu");
    }

    private static async Task EnsureSignedInAsync()
    {
        if (UnityServices.State != ServicesInitializationState.Initialized)
            await UnityServices.InitializeAsync();

        if (!AuthenticationService.Instance.IsSignedIn)
            await AuthenticationService.Instance.SignInAnonymouslyAsync();
    }

    private static string Sanitize(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "Player" + Random.Range(100, 999);
        var s = raw.Trim();
        s = Regex.Replace(s, @"\s+", "");                 // remove spaces
        s = Regex.Replace(s, @"[^A-Za-z0-9_\-]", "");     // safe chars only
        if (s.Length > 16) s = s[..16];
        if (s.Length < 3) s += Random.Range(100, 999);
        return s;
    }

    private static string TrimDiscriminator(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return "Player";
        int idx = s.IndexOf('#');
        return idx > 0 ? s.Substring(0, idx) : s;
    }

    private string GetOrGenerateUsername()
    {
        var cached = PlayerPrefs.GetString("GeneratedUsername", "");
        if (!string.IsNullOrEmpty(cached)) return cached;

        string[] prefixes = { "Cosmic", "Neon", "Quantum", "Steel", "Phantom" };
        string[] suffixes = { "Fox", "Raptor", "Wizard", "Pioneer", "Samurai" };
        var name = $"{prefixes[Random.Range(0, prefixes.Length)]}" +
                   $"{suffixes[Random.Range(0, suffixes.Length)]}" +
                   $"{Random.Range(100, 999)}";

        PlayerPrefs.SetString("GeneratedUsername", name);
        PlayerPrefs.Save();
        return name;
    }
}